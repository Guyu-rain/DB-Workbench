# 数据库管理系统 (DBMS) 设计需求文档

本项目旨在实现一个简易的关系型数据库管理系统，支持自定义二进制存储格式（.dbf 和 .dat）、基础的 DDL/DML 语句以及简单的条件查询。

---

## 1. 核心数据结构与文件布局

### 1.1 字段模式 (TableMode)
```c
#define FIELD_NAME_LENGTH 32

typedef struct {
  char sFieldName[FIELD_NAME_LENGTH];  // 字段名
  char sType[8];                       // 字段类型 (int, char[n])
  int iSize;                           // 字长
  char bKey;                           // 是否为KEY键 (1bit/char)
  char bNullFlag;                      // 是否允许为空
  char bValidFlag;                     // 字段有效标志 (1有效, 0无效)
} TableMode, *PTableMode;
```

### 1.2 物理文件布局
*   **数据库定义文件 (.dbf)**:
    - `[标识位 '~']` (1 byte)
    - `[表名]` (char数组)
    - `[字段数量]` (int)
    - `[TableMode 数组]` (定长/变长存储)
    - *(重复上述结构以存储多张表)*

*   **记录数据文件 (.dat)**:
    - `[标识位 '~']` (1 byte)
    - `[表名]` (char数组)
    - `[记录总数]` (int)
    - `[单个记录字段数]` (int)
    - `[记录有效位图]` (char数组，标记每条记录是否被删除)
    - `[数据区]` (按照 TableMode 中定义的 iSize 顺序存放字段数据)

---

## 2. 详细功能实现逻辑

### 2.1 词法与语法分析 (Parser)
- **实现原理**: 使用 `strtok` 或正则表达式对输入的 SQL 字符串进行分词。
- **状态机**: 识别 `CREATE`, `INSERT`, `SELECT` 等关键字。
- **关键逻辑**:
    1. 提取操作类型。
    2. 提取 `TableName`。
    3. 提取括号内的参数列表（字段定义或数值列表）。
    4. 提取 `INTO/IN` 后面的数据库物理文件名。

### 2.2 存储引擎 (Storage Engine)
- **Open/Close**: 封装 `fopen/fclose`，使用二进制模式 (`"rb+"`, `"ab+"`)。
- **定位算法**: 遍历 `.dbf/.dat` 文件，通过标识位 `~` 和表名比对来定位目标表的数据偏移量 (Offset)。

### 2.3 复杂查询 (Query Processing)
- **单表查询**: 
    1. 读取 `.dbf` 获取字段偏移。
    2. 扫描 `.dat`，对有效位为 1 的记录进行 `Condition` 匹配。
- **多表连接 (Join)**: 采用 **嵌套循环连接 (Nested Loop Join)**。
    1. 遍历表 A 的每一行。
    2. 对表 A 的当前行，遍历表 B 的所有行。
    3. 满足连接条件（如 `tableA.id = tableB.id`）时，合并字段放入结果集。

---

## 3. 函数交互流程 (Interaction Flow)

### 3.1 创建表流程 (DDL - CREATE)
1. **User**: 输入 `CREATE TABLE MyTable (...) INTO MyDB`。
2. **Parser**: 解析出表名 `MyTable`、字段属性数组及数据库 `MyDB.dbf`。
3. **DDL Module**: 调用 `Storage::CheckTableExists` 检查重名。
4. **Storage Engine**: 将解析好的 `TableMode` 数组序列化写入 `MyDB.dbf`。
5. **Storage Engine**: 在 `MyDB.dat` 中初始化表头（设置记录数为 0）。

### 3.2 插入数据流程 (DML - INSERT)
1. **Parser**: 解析 `INSERT INTO MyTable VALUES(...)`。
2. **DML Module**: 
    - 首先调用 `Storage::ReadTableSchema` 获取 `MyTable` 的字段类型和长度。
    - 将用户输入的字符串值按类型转换为二进制数据。
3. **Storage Engine**: 
    - 定位 `MyDB.dat` 中 `MyTable` 的末尾。
    - 写入数据，并更新表头中的 `记录总数`。

### 3.3 查询数据流程 (Query - SELECT)
1. **Parser**: 解析指令并生成 `QueryPlan`。
2. **Query Module**: 
    - 调用 `Storage::ReadTableSchema` 获取参与查询的所有表的结构。
    - 调用 `Storage::ReadRecordBlock` 将有效数据加载至内存缓冲区。
3. **Algorithms**: 执行 `Selection` (过滤) -> `Projection` (剪裁列) -> `Join` (如果是多表)。
4. **UI Module**: 将最终生成的结果集格式化并打印在屏幕上。

---

## 4. 异常处理
- **文件检查**: 如果 `.dbf` 不存在应报错。
- **类型检查**: INSERT 时若字符长度超过 `iSize` 或类型不匹配，需中断操作。
- **语法校验**: SQL 格式错误应返回具体位置提示。

