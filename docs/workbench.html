<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DB Workbench</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Inconsolata:wght@500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171b22;
      --panel-strong: #1e2430;
      --text: #e9edf5;
      --muted: #8a93a5;
      --accent: #a0e3c9;
      --accent-2: #ffaf45;
      --border: #232a36;
      --danger: #ff5f6d;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Inconsolata", sans-serif;
      background: radial-gradient(120% 120% at 20% 20%, rgba(61, 213, 152, 0.12), transparent),
                  radial-gradient(120% 120% at 80% 0%, rgba(255, 175, 69, 0.16), transparent),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 64px 1fr;
      grid-template-areas: "sidebar header" "sidebar main";
    }
    header {
      grid-area: header;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: rgba(23, 27, 34, 0.7);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    header .title {
      font-size: 18px;
      letter-spacing: 0.4px;
      font-weight: 600;
    }
    header .actions button {
      background: var(--panel-strong);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      margin-left: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 120ms ease, background 120ms ease;
    }
    header .actions button.primary {
      background: var(--accent);
      color: #0a0d12;
      border-color: transparent;
      box-shadow: 0 6px 20px rgba(61, 213, 152, 0.35);
    }
    header .actions button:hover { transform: translateY(-1px); }

    aside {
      grid-area: sidebar;
      background: rgba(23, 27, 34, 0.9);
      border-right: 1px solid var(--border);
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.6px;
    }
    .logo span {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: #0d1016;
      border-radius: 10px;
      padding: 8px 10px;
      font-variant: small-caps;
    }
    .nav-section { color: var(--muted); font-size: 12px; letter-spacing: 0.5px; }
    .nav {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .nav li {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: border 120ms ease, transform 120ms ease;
    }
    .nav li:hover { border-color: var(--accent); transform: translateX(3px); }
    .nav li.active { border-color: var(--accent); box-shadow: inset 0 0 0 1px rgba(61,213,152,0.2); }
    .badge { background: rgba(61, 213, 152, 0.18); color: var(--accent); padding: 2px 8px; border-radius: 999px; font-size: 11px; }

    main {
      grid-area: main;
      padding: 18px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 12px;
    }
    .surface {
      background: rgba(23, 27, 34, 0.82);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel-strong);
      color: var(--text);
      font-weight: 600;
    }
    .pill select, .pill input {
      background: transparent;
      border: none;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      outline: none;
      min-width: 120px;
    }
    .pill input { width: 200px; }

    .grid {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
      font-size: 14px;
    }
    .grid thead { color: var(--muted); letter-spacing: 0.2px; }
    .grid th, .grid td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    .grid tbody tr:hover { background: rgba(61, 213, 152, 0.06); }
    .chip {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      background: rgba(255, 175, 69, 0.16);
      color: var(--accent-2);
    }
    .chip.danger { background: rgba(255, 95, 109, 0.16); color: var(--danger); }

    @media (max-width: 960px) {
      body { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; grid-template-areas: "header" "sidebar" "main"; }
      aside { flex-direction: row; flex-wrap: wrap; }
      .nav { width: 100%; }
      .nav li { width: 100%; }
      .pill input { width: 140px; }
    }
  </style>
</head>
<body>
  <aside>
    <div class="logo"><span>DB</span> Workbench</div>
    
    <ul class="nav" style="margin-bottom:10px;">
        <li class="active" onclick="location.href='/'"><a href="/" style="text-decoration:none; color:inherit; display:block;">Dashboard</a></li>
        <li onclick="location.href='/sql'"><a href="/sql" style="text-decoration:none; color:inherit; display:block;">SQL Console</a></li>
    </ul>

    <!-- ****** 新增：数据库管理区域 ****** -->
    <div class="nav-section">数据库</div>
    <ul class="nav" style="margin-bottom: 12px;">
      <li style="flex-direction: column; align-items: stretch; gap: 8px;">
        <select id="dbSel" onchange="onDatabaseChange()" 
                style="width:100%; background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px;">
          <!-- 动态加载数据库列表 -->
        </select>
        <button onclick="createDatabase()" class="primary"
                style="width:100%; background:var(--accent); color:#0a0d12; border:none; border-radius:8px; padding:8px; cursor:pointer; font-weight:600;">
          + 创建数据库
        </button>
      </li>
    </ul>

    <!-- <div class="nav-section">数据表</div> -->
    <ul class="nav" id="tableListNav">
      <!-- 表列表将动态加载 -->
    </ul>
  </aside>

  <header>
    <div class="title">Local MySQL • <span id="currentDbTitle">MyDB</span></div>
    <div class="actions">
      <button onclick="createTable()">+ Add Table</button>
      <button onclick="addRow()">+ Insert Row</button>
      <button class="primary" id="runBtn" onclick="runQuery()">▶ Run</button>
      <button onclick="doLogout()" style="background:transparent; border:1px solid var(--danger); color:var(--danger); margin-left:12px;">Logout</button>
    </div>
  </header>

  <main>
    <section class="surface">
      <div class="toolbar">
        <!-- ****** 修改：Schema 下拉框改为只读，显示当前数据库 ****** -->
        <div class="pill">Schema <select id="schemaSel" disabled><option>MyDB</option></select></div>
        <div class="pill">Table <select id="tableSel" onchange="onTableChange()"></select></div>

        <div class="pill">
            Filter
            <select id="filterFieldSel"></select>
            <select id="filterOpSel">
              <option value="=">=</option>
              <option value="!=">!=</option>
              <option value=">">&gt;</option>
              <option value=">=">&gt;=</option>
              <option value="<">&lt;</option>
              <option value="<=">&lt;=</option>
              <option value="CONTAINS">CONTAINS</option>
            </select>
            <input id="filterValInput" placeholder="value">
          </div>

      </div>

      <div id="banner" style="margin-top:10px; display:none; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background: rgba(61, 213, 152, 0.08); color: var(--text); font-weight:600;"></div>

      <table class="grid" id="dataGrid">
        <thead><tr><th>ID</th><th>Name</th><th>Age</th><th>Role</th><th>Status</th><th style="width:120px; text-align:right;">Actions</th></tr></thead>
        <tbody></tbody>
      </table>

    </section>
  </main>

  <script>
    // ****** 修改：全局状态添加数据库信息 ******
    const state = {
      rows: [],
      loading: false,
      schemas: {},
      currentSchema: null,
      databases: [],      // 数据库列表
      currentDb: 'MyDB'   // 当前选中的数据库
    };

    // Auth Check
    if (!sessionStorage.getItem('db_token')) {
        window.location.href = '/login.html';
    }

    function setBanner(msg, color = 'var(--text)') {
      const el = document.getElementById('banner');
      if (!msg) { el.style.display = 'none'; return; }
      el.style.display = 'block';
      el.style.color = color;
      el.textContent = msg;
    }

    function setLoading(flag) {
      state.loading = flag;
      document.getElementById('runBtn').textContent = flag ? '… Running' : '▶ Run';
      document.getElementById('runBtn').disabled = flag;
    }

    async function api(path, payload = null, method = 'POST') {
      setLoading(true);
      setBanner('');
      try {
        const opts = { 
            method, 
            headers: { 
                'Content-Type': 'application/json',
                  'Authorization': sessionStorage.getItem('db_token') || ''
            } 
        };
        if (payload && method !== 'GET') opts.body = JSON.stringify(payload);
        const res = await fetch(path, opts);
        if (res.status === 401) { window.location.href = '/login.html'; return; }

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || '请求失败');
        return data;
      } catch (e) {
        setBanner(e.message || '请求失败', 'var(--danger)');
        throw e;
      } finally {
        setLoading(false);
      }
    }

    function esc(s) {
      return String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // ****** 新增：加载数据库列表 ******
    async function loadDatabases() {
      try {
        const data = await api('/api/databases', null, 'GET');
        state.databases = data.databases || [];
        
        const sel = document.getElementById('dbSel');
        const current = sel.value || state.currentDb;
        sel.innerHTML = '';
        
        state.databases.forEach(db => {
          const opt = document.createElement('option');
          opt.value = db;
          opt.textContent = db;
          sel.appendChild(opt);
        });
        
        // 恢复选择或默认选中第一个
        if (state.databases.includes(current)) {
          sel.value = current;
          await api('/api/use_database', { database: current });
        } else if (state.databases.length > 0) {
          sel.value = state.databases[0];
          state.currentDb = state.databases[0];
          await api('/api/use_database', { database: state.currentDb });
        }
      } catch (e) {
        console.error('加载数据库失败:', e);
      }
    }

    // ****** 新增：创建数据库 ******
    async function createDatabase() {
      let input = prompt('请输入创建数据库SQL语句：', 'create database mydb');
      if (!input) return;

      
      let name = input.replace(/create\s+database\s+/i, '').trim();

      // 2. 校验提取后的名称是否合法（只允许字母、数字、下划线）
      if (!name || !/^[a-zA-Z0-9_]+$/.test(name)) {
        setBanner('数据库名称无效（提取值：' + name + '）', 'var(--danger)');
        return;
      }
      
      try {
        await api('/api/create_database', { database: name });
        setBanner(`数据库 "${name}" 创建成功`);
        await loadDatabases(); // 刷新列表
        document.getElementById('dbSel').value = name;
        await onDatabaseChange(); // 自动切换到新数据库
      } catch (e) {
        setBanner(e.message, 'var(--danger)');
      }
    }

    // ****** 新增：切换数据库 ******
    async function onDatabaseChange() {
      const dbName = document.getElementById('dbSel').value;
      if (!dbName) return;
      
      try {
        // 新增：清空旧状态，防止脏数据
        state.schemas = {};
        state.currentSchema = null;
        state.rows = [];
        renderTable([]); // 立即清空表格

        await api('/api/use_database', { database: dbName });
        state.currentDb = dbName;
        document.getElementById('currentDbTitle').textContent = dbName;
        document.getElementById('schemaSel').innerHTML = `<option>${dbName}</option>`;
        
        await loadTables();
        
        // 新增：强制刷新表选择器和数据
        const tableSel = document.getElementById('tableSel');
        if (tableSel.options.length > 0) {
          tableSel.value = tableSel.options[0].value;
          await onTableChange(); // 立即触发查询
        } else {
          // 新增：无表时清空状态
          setCurrentSchema(null);
          renderTable([]);
        }
        
        setBanner(`已切换到数据库: ${dbName}`);
      } catch (e) {
        setBanner(e.message, 'var(--danger)');
      }
    }

    async function loadTables() {
      try {
        const data = await api('/api/schemas', null, 'GET');
        const schemas = data.schemas || [];

        
        state.schemas = {};
        schemas.forEach(s => state.schemas[String(s.table || '').toLowerCase()] = s);

        const sel = document.getElementById('tableSel');
        const current = sel.value;
        sel.innerHTML = '';
        schemas.forEach(s => {
          const name = s.table;
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });

        if (current && schemas.some(s => s.table === current)) sel.value = current;
        if (!sel.value && sel.options.length > 0) sel.value = sel.options[0].value;

        setCurrentSchema(sel.value);
      } catch (e) {
        console.error(e);
      }
    }

    function setCurrentSchema(tableName) {
      const key = String(tableName || '').toLowerCase();
      state.currentSchema = state.schemas[key] || null;

      // populate filter field select
      const fieldSel = document.getElementById('filterFieldSel');
      fieldSel.innerHTML = '';
      if (state.currentSchema && Array.isArray(state.currentSchema.fields)) {
        state.currentSchema.fields.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.name;
          opt.textContent = f.name;
          fieldSel.appendChild(opt);
        });
      }
    }

    function renderTable(rows) {
      const schema = state.currentSchema;
      const table = document.getElementById('dataGrid');

      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');

      if (!schema || !Array.isArray(schema.fields)) {
        thead.innerHTML = '<tr><th>Empty schema</th></tr>';
        tbody.innerHTML = '';
        return;
      }

      // header
      thead.innerHTML = `<tr>
        ${schema.fields.map(f => `<th>${esc(f.name)}</th>`).join('')}
        <th style="width:120px; text-align:right;">Actions</th>
      </tr>`;

      // rows
      tbody.innerHTML = rows.map((r, idx) => {
        const cells = schema.fields.map(f => {
          const key = String(f.name || '').toLowerCase();
          return `<td>${esc(r[key])}</td>`;
        }).join('');

        // pick id for edit/delete: assume first key field; fallback first column
        const idKey = (schema.fields.find(x => x.isKey) || schema.fields[0]).name;
        const idVal = r[String(idKey).toLowerCase()];

        return `<tr>
          ${cells}
          <td style="text-align:right; display:flex; gap:6px; justify-content:flex-end;">
            <button style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer;" onclick="editRowByIndex(${idx})">Edit</button>
            <button style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer;" onclick="deleteRowByIndex(${idx})">Delete</button>
          </td>
        </tr>`;
      }).join('');
    }

    // ****** 修改：runQuery 使用当前数据库 ******
    async function runQuery() {
      const table = document.getElementById('tableSel').value;

      const field = document.getElementById('filterFieldSel').value;
      const op = document.getElementById('filterOpSel').value;
      const valRaw = (document.getElementById('filterValInput').value || '').trim();

      let filter = '';
      if (valRaw !== '') {
        const needsQuote = /\s/.test(valRaw);
        const val = needsQuote ? `"${valRaw.replace(/"/g, '\\"')}"` : valRaw;
        filter = (op === 'CONTAINS') ? `${field} CONTAINS ${val}` : `${field} ${op} ${val}`;
      }

      try {
        const data = await api('/api/query', { 
          schema: state.currentDb,  // 使用当前数据库
          table, 
          filter, 
          limit: 200 
        });
        state.rows = data.rows || [];
        renderTable(state.rows);
      } catch (e) {
        console.error(e);
      }
    }

    // ****** 修改：addRow 使用当前数据库 ******
    async function addRow() {
      const schema = state.currentSchema;
      if (!schema) return;

      const row = {};
      for (const f of schema.fields) {
        const key = String(f.name || '').toLowerCase();
        const hint = f.isKey ? '(leave empty for auto)' : '';
        const v = prompt(`${f.name} ${hint}`, '');
        if (v === null) return;
        row[key] = v;
      }

      try {
        await api('/api/insert', { 
          schema: state.currentDb,  // 使用当前数据库
          table: state.currentSchema.table, 
          row 
        });
        setBanner('插入成功');
        await runQuery();
      } catch (e) {
        console.error(e);
      }
    }

    // ****** 修改：createTable 使用当前数据库 ******
    async function createTable() {
      const sql = prompt(
        'CREATE TABLE SQL',
        'CREATE TABLE users2 (id int primary key, name char[32] not null, age int, role char[16], status char[16])'
      );
      if (sql === null || sql.trim() === '') return;

      try {
        await api('/api/create_table', { sql: sql.trim() });
        await loadTables();
        setBanner('创建成功');
        await runQuery();
      } catch (e) {
        console.error(e);
      }
    }

    // ****** 修改：editRowByIndex 使用当前数据库 ******
    async function editRowByIndex(idx) {
      const schema = state.currentSchema;
      const row0 = state.rows[idx];
      if (!schema || !row0) return;

      const keyField = (schema.fields.find(x => x.isKey) || schema.fields[0]);
      const idKey = String(keyField.name).toLowerCase();
      const idVal = row0[idKey];
      if (!idVal) return;

      const patch = {};
      for (const f of schema.fields) {
        const k = String(f.name).toLowerCase();
        if (k === idKey) continue;
        const oldV = row0[k] ?? '';
        const v = prompt(`${f.name}`, oldV);
        if (v === null) return;
        patch[k] = v;
      }

      try {
        await api('/api/update', { 
          schema: state.currentDb,  // 使用当前数据库
          table: state.currentSchema.table, 
          id: String(idVal), 
          patch 
        });
        setBanner('更新成功');
        await runQuery();
      } catch (e) {
        console.error(e);
      }
    }

    // ****** 修改：deleteRowByIndex 使用当前数据库 ******
    async function deleteRowByIndex(idx) {
      const schema = state.currentSchema;
      const row = state.rows[idx];
      if (!schema || !row) return;

      const keyField = (schema.fields.find(x => x.isKey) || schema.fields[0]);
      const idKey = String(keyField.name).toLowerCase();
      const idVal = row[idKey];
      if (!idVal) return;

      if (!confirm('Delete row #' + idVal + '?')) return;

      try {
        await api('/api/delete', { 
          schema: state.currentDb,  // 使用当前数据库
          table: state.currentSchema.table, 
          id: String(idVal) 
        });
        setBanner('删除成功');
        await runQuery();
      } catch (e) {
        console.error(e);
      }
    }

    async function onTableChange() {
      const table = document.getElementById('tableSel').value;
      setCurrentSchema(table);
      await runQuery();
    }

    // ****** 修改：初始化时先加载数据库 ******
    function doLogout() {
      sessionStorage.removeItem('db_token');
      sessionStorage.removeItem('db_user');
      localStorage.removeItem('db_token');
      localStorage.removeItem('db_user');
      window.location.href = '/login.html';
    }

    (async () => {
      await loadDatabases();  // 先加载数据库列表
      await loadTables();     // 再加载表
      const sel = document.getElementById('tableSel');
      if (!sel.value && sel.options.length > 0) sel.value = sel.options[0].value;
      await runQuery();
    })();
  </script>
</body>
</html>
